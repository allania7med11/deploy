- name: Ensure correct permissions for /home/vagrant directory
  become: yes
  file:
    path: /home/vagrant
    owner: vagrant
    group: vagrant
    mode: "0755"
  ignore_errors: yes 

- name: Check if PostgreSQL database exists
  shell: |
    sudo -u postgres psql -lqt | cut -d '|' -f 1 | grep -qw 'shop_db' && echo 0 || echo 1
  changed_when: false
  register: db_exists
  ignore_errors: yes

- set_fact:
    database_exists: "{{ db_exists.stdout == '0' }}"

- name: Create template1 database from template0
  become: yes
  command: >
    sudo -u postgres psql -U {{ postgres_user }} -d postgres -c "CREATE DATABASE template1 TEMPLATE template0;"
  environment:
    PGPASSWORD: "{{ postgres_password }}"
  when: not database_exists
  ignore_errors: yes

- name: Ensure PostgreSQL database is created if not exists
  command: >
    sudo -u postgres createdb -U {{ postgres_user }} -O {{ postgres_user }} {{ db_name }}
  environment:
    PGPASSWORD: "{{ postgres_password }}"
  ignore_errors: no
  register: create_db_result
  when: not database_exists

- name: Debug
  debug:
    msg: "sudo -u postgres psql -d {{ db_name }} -f {{ db_init_path }}"

- name: Load data to PostgreSQL database
  command: >
    sudo -u postgres psql -d {{ db_name }} -f {{ db_init_path }}
  environment:
    PGPASSWORD: "{{ postgres_password }}"
  become: yes
  when: create_db_result is succeeded

